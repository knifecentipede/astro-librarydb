---
import { db, like, eq, Author, Book } from "astro:db";
import Layout from "../layouts/Layout.astro";
const pageTitle = "Upload book";

export const prerender = false;

if (Astro.request.method === "POST") {
    // ADD VALIDATION!!!!!!!!!
    const data = await Astro.request.formData();
    const title = data.get("title");
    const isbn = data.get("isbn");

    // author lookup
    const name = data.get("name");
    const lookup = await db
        .select()
        .from(Author)
        .where(like(Author.name, name));
    let extractId = lookup.map((a) => a.id);
    // extracted id FOR WHEN BOOKS ONLY HAVE ONE AUTHOR
    // SEE BETTER IMPLEMENTATION IN INDEX
    // STANDARTIZE THIS
    const authorId = extractId[0];

    await db.insert(Book).values({ title, authorId, isbn });
}
---

<Layout pageTitle={pageTitle}>
    <form method="POST">
        <!-- ADD VALIDATION!!!!!!!!! -->
        <label>
            Title:
            <input type="text" name="title" required />
        </label>
        <label>
            <!-- DIFFICULTY ZONE -->
            <!-- author can be suggested as you type -->
            <!-- tier 1: if none, return error -->
            <!-- tier 2: if none, create author automatically -->
            Author:
            <input type="text" name="name" />
        </label>
        <label>
            ISBN:
            <input type="text" name="isbn" />
        </label>
        <!-- high diff: -->
        <!-- file upload -->
        <!-- image upload -->
        <button>Upload</button>
    </form>
</Layout>

<style>
    form {
        display: grid;
    }
    button {
        width: 200px;
    }
</style>
